{% extends "base.html" %}
{% block content %}

<h2>ìš°ë¦¬ ë™ë„¤ ëª¨ì§‘ê¸€</h2>
<p><a href="/posts/new">+ ëª¨ì§‘ê¸€ ì‘ì„±</a></p>

<style>
  .node { margin: 10px 0; }
  .toggle {
    cursor: pointer;
    border: none;
    background: #f2f2f2;
    padding: 8px 10px;
    border-radius: 8px;
    width: 100%;
    text-align: left;
    font-weight: 600;
  }
  .children { margin-left: 14px; margin-top: 6px; display: none; }
  .subtoggle {
    cursor: pointer;
    border: none;
    background: #fafafa;
    padding: 6px 10px;
    border-radius: 8px;
    width: 100%;
    text-align: left;
  }
  .posts { margin-left: 14px; margin-top: 6px; display: none; }
  .badge {
    background:#eee; padding:2px 6px; border-radius:4px;
    margin-left:6px; font-size: 12px;
  }
</style>

{% for cat in category_order %}
  {% set submap = grouped.get(cat) %}
  {% set cat_count = 0 %}
  {% if submap %}
    {% for sub, arr in submap.items() %}
      {% set cat_count = cat_count + (arr|length) %}
    {% endfor %}
  {% endif %}

  <div class="node">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <button class="toggle" type="button" data-target="cat-{{ cat }}">
        {% if cat == "MART" %}ğŸ“¦ ë§ˆíŠ¸ ì†Œë¶„
        {% elif cat == "DELIVERY" %}ğŸ” ë°°ë‹¬ ì†Œë¶„
        {% else %}ğŸ“Œ ê¸°íƒ€
        {% endif %}
        <span class="badge">{{ cat_count }}</span>
      </button>

      <a href="/posts/new?category={{ cat }}"
        style="background:#8e8e8e; color:white; padding:6px 10px;
                border-radius:8px; text-decoration:none; font-size:14px;
                white-space:nowrap; display:inline-block;">
        + ê¸€ ì‘ì„±
      </a>
    </div>

    <div class="children" id="cat-{{ cat }}">
      {% if not submap or (submap|length == 0) %}
        <p style="color:gray; margin:8px 0;">ê¸€ì´ ì—†ì–´.</p>
      {% else %}

        {% for sub, arr in submap.items() %}
          <div class="node">
            <button class="subtoggle" type="button" data-target="sub-{{ cat }}-{{ loop.index }}">
              â–¸ {{ sub }} <span class="badge">{{ arr|length }}</span>
            </button>

            <div class="posts" id="sub-{{ cat }}-{{ loop.index }}">
              <ul>
                {% for p in arr %}
                  <li>
                    <a href="/posts/{{ p.id }}">[{{ p.status }}] {{ p.title }}</a>
                    - {{ p.item_name }} (ì´ {{ p.total_qty }}, 1ëª« {{ p.unit_qty }})
                    {% set badge = deadline_badge(p.deadline) %}
                    {% if badge %}
                      <span class="badge">{{ badge }}</span>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        {% endfor %}

      {% endif %}
    </div>
  </div>
{% endfor %}

<script>
  function toggleById(id) {
    const el = document.getElementById(id);
    if (!el) return;
    el.style.display = (el.style.display === "none" || el.style.display === "") ? "block" : "none";
  }

  document.querySelectorAll("[data-target]").forEach(btn => {
    btn.addEventListener("click", () => toggleById(btn.dataset.target));
  });
</script>

{% endblock %}